include common : open;

struct spawn {
    type: u16;
    priority: u8;
    algorithm: u8;
    padd: u16;
    flags: u16;
    padd: u8;
    ctfd: u8;
    stdfds: stdfds;
    argc: u16;
    envc: u16;
    # argc and envc data follow, not yet clear in which format
}

struct loaded_reply {
    status: u16;
    son_pid: pid;
    padd: u16;
}

msg spawn {
    type: 3;

    request spawn;
    reply loaded_reply;
}

msg exec {
    type: 4;

    request spawn;
    reply loaded_reply;
}

msg fork {
    type: 5;

    request {
        flags: u16;
    }
    reply loaded_reply;
}

msg wait {
    type: 27;

    request {
        options: u16;
        pid: pid;
        padd: u16;
        xstatus: u32;
    }

    reply {
        status: u16;
        padd: u16;
        pid: pid;
        padd: u16;
        xstatus: u32;
    }
}

struct segment_request {
    type: u16;
    subtype: u16;

    sel: u16;
    srcpid: pid;
    padd_1: u16;
    dstpid: pid;
    padd_2: u16;
    flags: u16 hex;
    padd_3: u16;
    addr: u32 hex;
    nbytes: u32 hex;
}

struct segment_reply {
    status: u16;
    sel: u16;
    flags: u16 hex;
    addr: u32 hex;
    nbytes: u32 hex;
}

msg segment_alloc {
    type: 9;
    subtype: 1;

    request segment_request;
    reply segment_reply;
}

msg segment_realloc {
    type: 9;
    subtype: 3;

    request segment_request;
    reply segment_reply;
}

msg time {
    type: 14;
    request {
        padd: u16;
        seconds: u32;
        nsec: u32;
    }
    reply {
        status: u16;
        padd: u16;
        seconds: u32;
        nsec: u32;
    }
}


msg terminate {
    type: 24;

    request {
        signum: u16;
        status: u32;
    }

    reply {}
}

msg open {
    # Seems to match _io_open, used also for reply and maybe other commds
    type: 25;
    
    request open;
    reply open;
}

struct fd_request {
    type: u16 hex;
    subtype: u16 hex;
    fd: fd;
    owner_pid: pid;
    zero1: u16;
    nid: nid;
    pid: pid;
    zero2: u16;
    vid: pid;
    zero3: u16;
    flags: u16;
    handle: u16;
    zero4: u16;
}

struct fd_reply1 {
    status: u16;
    fd: fd;
    padd: u16;
    padd: u16;
}

struct fd_entry {
    nid: nid;
    pid: pid;
    padd: u16;
    vid: pid;
    padd: u16;
    handle: u16;
    flags: u16;
}

msg fd_attach {
    type: 22;
    subtype: 0;

    request fd_request;
    reply fd_reply1;
}

msg fd_detach {
    type: 22;
    subtype: 1;

    request fd_request;
    reply fd_reply1;
}

msg fd_query {
    type: 22;
    subtype: 2;

    request fd_request;
    reply {
        status: u16;
        info: fd_entry;
        fd: u16;
    }
}

msg fd_action1 {
    type: 22;
    subtype: 4;
    # Not clear what this is doing but it is called during opendir with unclear purpose
    request fd_request;
    reply {
        status: u16;
        padd: u16;
        padd: u16;
    }
}

struct vc {
    # not 100%
    type: u16;
    flags: u16;
    nid: nid;
    pid: pid;
    padd: u16;
    length:u16;
}

msg vc_attach {
    type: 31;
    request vc;
    reply {
        status: u16;
        pid: u16;
    }
}

msg vc_detach {
    type: 32;
    request vc;
    reply vc;
}

msg psinfo {
    type: 34;
    request {
        pid: pid;
        padd: u16;
        memindex: u16;
    }
    reply {
        status: u16;
        # psinfo follows
        # 16 segs follow
    }
}

struct signal_request {
    type: u16;
    subtype: u16;

    signum: u16;
    pid: pid;
    padd: u16;
    mask: u32 hex;
    bits: u32 hex;
    offset: u32 hex;
    segment: u16 hex;
}

struct signal_reply {
    status: u16;
    padd: u16;
    old_bits: u32 hex;
    new_bits: u32 hex;
}

msg sigtab {
    type: 8;
    subtype: 0;
    request signal_request;
    reply signal_reply;
}

# sigaction subtype 1 deprecated

msg sigmask {
    type: 8;
    subtype: 2;
    request signal_request;
    reply signal_reply;
}

msg sigraise {
    type: 8;
    subtype: 3;
    request signal_request;
    reply signal_reply;
}

msg sigpending {
    type: 8;
    subtype: 4;
    request signal_request;
    reply signal_reply;
}

msg sigact {
    type: 8;
    subtype: 5;
    request signal_request;
    reply signal_reply;
}

msg sigsuspend {
    type: 8;
    subtype: 6;
    request signal_request;
    reply signal_reply;
}

msg getid {
    type: 12;
    subtype: 0x0;
    request {}
    reply {
        status: u16;
        # not clear, guessed by results
        padd: u16;
        padd: u16;

        # from here it is psinfo3
        pid: u16;
        padd: u16;
        ppid: u16;
        pid_group:u16;
        padd: u16;
        flags: u32;
        rgid: u16;
        ruid: u16;
        egid: u16;
        euid: u16;
    }
}

msg osinfo {
    type: 23;
    request {}
    reply {
        status: u16;
        # osinfo structure goes here
    }
}